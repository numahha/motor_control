# モータドライバ調整

電流制御を行うようにモータドライバを調整する。

## DCモータと電流制御の復習
DCモータの場合、電流iと発生トルクTの間には、線形（T=K×i）の関係が成り立つ。
強調すると、発生トルクは電流「のみ」に比例する。
そのため、発生トルクを電流を通じて制御できる。
（モータの回転数に応じて逆起電力が生じるため、電圧を通じてトルクを制御しようとすると電流よりも大変である）

I/Oボードから出せるのは指令電圧（電圧信号・電流は小さい）なので、そのままでは使えない。
電流制御モードでのモータドライバは、
* （I/Oボードから）指令電圧を受け取り、
* （モータへと）電圧信号に比例する出力電流を流す。
という役割を担う。


## モータドライバの調整項目

モータドライバとして、[SERVOLAND SMCM2-AI](http://www.servoland.co.jp/products/price.html#SMC)を用いる。これは、可変抵抗を通じて調整するタイプである。

指令電圧Vref・出力電流Ioutとすると、Iout = a×Vref+bという関係がある。
それぞれの可変抵抗器の（マニュアル上での表記に準拠）は、
* VROとVRIOは係数bを調整する（オフセット調整。それぞれ、微調整と大まかな調整）。
* VRIは係数aを調整する（ゲイン調整）。
* VRΦは最大出力電圧（出力電流と逆起電力に依存）を調整する。
という役割を持つ。


## 調整目標

サーボモータの指令値のレンジは10Vの大きさである（マニュアル参照）。
I/Oボードの出力電圧のレンジも5 or 10Vの大きさであり、我々は10Vレンジのモードで用いる。（マニュアル参照）。

[技術資料](https://www.hds.co.jp/products/dl_technicaldocument/index.html#rotary-rh-001)より、
モータの仕様を確認する。これに基づいて、以下のように設定するとする。
* 定格電流1A（瞬時最大電流1.6A）なので、1Aの大きさまでの電流を扱うこととする。つまり、+10Vの指令電圧で+1Aの電流を流すとする。
* 定格電圧24Vなので、10%増しで26Vを最大出力電圧とする。


## 調整方法
* セメント抵抗（10W 2ΩK）を使って調節する（ちなみに、Ω（オーム）K（誤差５％））。これを直列に5つ繋ぐ。つまり、10Ωとなる。電圧は、電流を10倍して求められるようになる。
* 電流1Aの場合には電力は2×1×1=2Wになり、これは10Wより小さい。電流2.6Aの時には、2×2.6×2.6=13.52Wとなる。~~これは10Wを超えているけど、長い間使うわけではないので気にしないことにする。~~

1. 登場人物を繋ぐ[（写真）](https://github.com/numahha/motor_control/blob/master/2_tuning_motor_driver/IMG_20200403_175516.jpg)
* モータドライバ・電流計・セメント抵抗（出力電流）
* モータドライバ・I/Oボード・PC（指令電圧）
* モータドライバ・コンセント（電源供給）


2. I/OボードのDAのモジュールをロードする（[参照](https://github.com/numahha/interface_ubuntu18/tree/master/a_test_interface)）。
```
cd /usr/src/interface/gpg6204/x86_64/linux/drivers
sudo bash inspenc.sh
sudo bash setup.sh
```
GPG/GPH-6204でエンター→command number:99でエンター。
```
cd /usr/src/interface/gpg3300/x86_64/linux/drivers
sudo bash insda.sh
sudo bash setup.sh
```
GPG/GPH-3300でエンター→command number:99でエンター。

指令電圧を対話式で与えるプログラム`tune.c`を実行する（このディレクトリにおいて以下のコマンド）。
```
make clean
make
./tune
```
使い方は、実行時にコンソール上に表示される。


3. 最大出力電圧を調整する。
* まず、オフセットをラフに調整する（あとでもう一度調整する）。
* 指令電圧2Vに対して出力電流が0.6A程度になるようにVRIを弄る。
* オフセットがだいたい取れていて、最大出力電圧が30Vより大きければ、指令電圧10Vに対して3A程度の電流が流れているはずである。
* 上の状況を作ってから、出力電流が2.6Aとなるように、VRΦを弄る。
これで、2.6×10=26Vの最大出力電圧が設定された。


4. ゲインとオフセットを調整する。
* 指令電圧を-10, -8, -6, -4, -2, 0, 2, 4, 6, 8, 10Vと変えていって、それぞれ、出力電流が-1, -0.8, -0.6, -0.4, -0.2, 0, 0.2, 0.4, 0.6, 0.8, 1Aとなるように、VROとVRIOとVRIを調整する（触れば分かる）。
* ~~ある程度のところで妥協する。~~
